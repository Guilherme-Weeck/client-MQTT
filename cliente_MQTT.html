<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MQTT Test Client </title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#2dd4bf;--danger:#ff6b6b}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Arial; margin:0; padding:18px; background:linear-gradient(180deg,#071023 0%, #071426 100%); color:#e6eef6}
    h1{font-size:20px;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    label{display:block;color:var(--muted);font-size:12px;margin-top:8px}
    input,select,button,textarea{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .small{width:90px}
    .btn{cursor:pointer;border:none}
    .btn-primary{background:var(--accent);color:#062022}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    #status{font-weight:700}
    .status-connected{color:#34d399}
    .status-disconnected{color:#fb7185}
    #topics-list{max-height:160px;overflow:auto;margin-top:8px}
    .topic-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:rgba(255,255,255,0.01);margin-bottom:6px}
    pre#log{background:#071426;padding:10px;border-radius:8px;max-height:420px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
    .controls{display:flex;gap:8px;margin-top:8px}
    .muted{color:var(--muted);font-size:13px}
    .flex{display:flex;gap:8px;align-items:center}
    .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:12px}
    .footer{margin-top:12px;color:var(--muted);font-size:13px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>MQTT Test Client </h1>
  <p class="muted">Base leve com mqtt.js, mÃºltiplos tÃ³picos, histÃ³rico (localStorage), export/import de configuraÃ§Ã£o e UI.</p>

  <div class="grid">
    <div class="card">
      <h3>ConexÃ£o</h3>
      <label>Broker (ws:// ou wss://)</label>
      <input id="broker" placeholder="wss://broker.hivemq.com:8884/mqtt" />

      <div class="row">
        <div>
          <label>Client ID</label>
          <input id="clientId" placeholder="gerado automaticamente" />
        </div>
        <div>
          <label>Keep Alive (s)</label>
          <input id="keepalive" value="60" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>UsuÃ¡rio (opcional)</label>
          <input id="username" />
        </div>
        <div>
          <label>Senha (opcional)</label>
          <input id="password" type="password" />
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="connectBtn" class="btn btn-primary">ðŸ”Œ Conectar</button>
        <button id="disconnectBtn" class="btn btn-ghost">â›” Desconectar</button>
      </div>

      <p class="muted">Status: <span id="status" class="status-disconnected">Desconectado</span></p>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03)" />

      <h3>Gerenciar tÃ³picos</h3>
      <label>TÃ³pico para assinar</label>
      <div class="row">
        <input id="subscribeTopic" placeholder="ex: devices/+/telemetry" />
        <select id="subscribeQos">
          <option value="0">QoS 0</option>
          <option value="1">QoS 1</option>
          <option value="2">QoS 2</option>
        </select>
      </div>
      <div class="controls">
        <button id="addTopicBtn" class="btn btn-primary">âž• Inscrever</button>
        <button id="clearSubsBtn" class="btn btn-ghost">Limpar inscriÃ§Ãµes</button>
      </div>
      <div id="topics-list"></div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03)" />

      <h3>Publicar</h3>
      <label>TÃ³pico</label>
      <input id="pubTopic" placeholder="topic/to/publish" />
      <label>Mensagem (texto ou JSON)</label>
      <textarea id="pubPayload" rows="4" placeholder='{"key": "value"}'></textarea>
      <div class="row" style="margin-top:6px">
        <select id="pubQos"><option value="0">QoS 0</option><option value="1">QoS 1</option><option value="2">QoS 2</option></select>
        <div style="flex:1"><label style="display:none">retain</label><div style="margin-top:8px"><input type="checkbox" id="pubRetain" /> <label for="pubRetain" class="muted">Retain</label></div></div>
      </div>
      <div style="margin-top:8px" class="row">
        <button id="publishBtn" class="btn btn-primary">ðŸ“¤ Publicar</button>
        <button id="lastWillBtn" class="btn btn-ghost">ðŸ’¬ Definir LastWill</button>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03)" />

      <div class="flex" style="margin-top:8px">
        <div class="chip">HistÃ³rico: <span id="histCount">0</span></div>
        <div class="chip">InscriÃ§Ãµes: <span id="subsCount">0</span></div>
      </div>

      <div class="footer">
        <button id="exportBtn" class="btn btn-ghost">Exportar Config (JSON)</button>
        <button id="importBtn" class="btn btn-ghost">Importar Config</button>
        <input id="fileInput" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Mensagens (log)</h3>
        <div class="row" style="max-width:420px">
          <input id="filterTopic" placeholder="Filtrar por tÃ³pico (parte)" />
          <select id="filterQos"><option value="all">Todos QoS</option><option value="0">QoS0</option><option value="1">QoS1</option><option value="2">QoS2</option></select>
        </div>
      </div>

      <pre id="log"></pre>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="clearLogBtn" class="btn btn-ghost">Limpar log</button>
        <button id="downloadLogBtn" class="btn btn-primary">ðŸ“¥ Baixar log</button>
        <div style="flex:1"></div>
        <div class="muted">Salvo no navegador (localStorage)</div>
      </div>
    </div>
  </div>

<script>
// --- helpers ---
const $ = id => document.getElementById(id)
const now = () => new Date().toISOString().replace('T',' ').slice(0,19)

// --- state ---
let client = null
let state = {
  config: { broker:'wss://broker.hivemq.com:8884/mqtt', clientId:'', username:'', password:'', keepalive:60 },
  subscriptions: [], // {topic,qos}
  log: [] // {ts,topic,qos,payload,direction}
}

// --- localStorage keys ---
const KEY = 'mqtt-client-pro-v1'

// --- init ---
function loadState(){
  const raw = localStorage.getItem(KEY)
  if(raw){
    try{ state = JSON.parse(raw) }catch(e){ console.warn('localStorage parse error',e) }
  }
}
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)) }

function renderConfig(){
  $('broker').value = state.config.broker || ''
  $('clientId').value = state.config.clientId || ''
  $('username').value = state.config.username || ''
  $('password').value = state.config.password || ''
  $('keepalive').value = state.config.keepalive || 60
}

function renderSubs(){
  const list = $('topics-list')
  list.innerHTML = ''
  state.subscriptions.forEach((s,idx)=>{
    const div = document.createElement('div')
    div.className = 'topic-item'
    div.innerHTML = `<div><strong>${s.topic}</strong> <span class="muted">(QoS ${s.qos})</span></div>`
    const actions = document.createElement('div')
    actions.innerHTML = `<button data-idx="${idx}" class="btn btn-ghost">âœ–</button>`
    actions.querySelector('button').addEventListener('click',()=>{ unsubscribeByIndex(idx) })
    div.appendChild(actions)
    list.appendChild(div)
  })
  $('subsCount').textContent = state.subscriptions.length
}

function renderLog(){
  const pre = $('log')
  const filterTopic = $('filterTopic').value.trim().toLowerCase()
  const filterQos = $('filterQos').value
  const lines = state.log.filter(item=>{
    if(filterTopic && !item.topic.toLowerCase().includes(filterTopic)) return false
    if(filterQos!=='all' && String(item.qos)!==filterQos) return false
    return true
  }).map(item=>`[${item.ts}] ${item.direction} ${item.topic} (QoS ${item.qos})\n${item.payload}\n`)
  pre.textContent = lines.join('\n')
  $('histCount').textContent = state.log.length
}

// --- MQTT operations ---
function connect(){
  if(client && client.connected){ return }
  const broker = $('broker').value.trim()
  if(!broker.startsWith('ws')){ alert('Broker precisa usar ws:// ou wss://'); return }
  const clientId = $('clientId').value.trim() || ('webclient-' + Math.random().toString(16).slice(2,10))
  state.config = { broker, clientId, username:$('username').value, password:$('password').value, keepalive: parseInt($('keepalive').value)||60 }
  saveState(); renderConfig()

  const opts = { clientId: state.config.clientId, keepalive: state.config.keepalive, clean: true }
  if(state.config.username) opts.username = state.config.username
  if(state.config.password) opts.password = state.config.password

  try{
    client = mqtt.connect(state.config.broker, opts)
  }catch(e){ alert('Erro ao iniciar cliente: '+e.message); return }

  $('status').textContent = 'Conectando...'
  $('status').className = ''

  client.on('connect',()=>{
    $('status').textContent = 'Conectado'
    $('status').className = 'status-connected'
    appendLog({topic:'__client__',qos:0,payload:'connected',direction:'INFO'})
    // subscribe existing subscriptions
    state.subscriptions.forEach(s=> client.subscribe(s.topic, {qos: s.qos}, err=>{
      if(err) appendLog({topic:s.topic,qos:s.qos,payload:'subscribe error: '+String(err),direction:'ERROR'})
      else appendLog({topic:s.topic,qos:s.qos,payload:'subscribed',direction:'INFO'})
    }))
    saveState(); renderSubs(); renderLog()
  })

  client.on('reconnect',()=>{
    $('status').textContent = 'Reconectando...'
    $('status').className = ''
  })
  client.on('error',(err)=>{
    $('status').textContent = 'Erro'
    $('status').className = 'status-disconnected'
    appendLog({topic:'__client__',qos:0,payload:'error: '+ (err && err.message),direction:'ERROR'})
  })
  client.on('close',()=>{
    $('status').textContent = 'Desconectado'
    $('status').className = 'status-disconnected'
    appendLog({topic:'__client__',qos:0,payload:'closed',direction:'INFO'})
  })
  client.on('message',(topic, payload, packet)=>{
    appendLog({topic, qos: packet.qos, payload: payload.toString(), direction:'RECEIVED'})
  })
}

function disconnect(){
  if(client){ try{ client.end(); client = null }catch(e){} }
  $('status').textContent = 'Desconectado'
  $('status').className = 'status-disconnected'
}

function subscribeTopic(){
  const topic = $('subscribeTopic').value.trim(); const qos = parseInt($('subscribeQos').value)
  if(!topic) return alert('Informe um tÃ³pico')
  // avoid duplicates
  if(state.subscriptions.find(s=>s.topic===topic)) return alert('JÃ¡ inscrito neste tÃ³pico')
  state.subscriptions.push({topic,qos})
  saveState(); renderSubs()
  if(client && client.connected){
    client.subscribe(topic, {qos}, err=>{
      if(err) appendLog({topic,qos,payload:'subscribe error: '+String(err),direction:'ERROR'})
      else appendLog({topic,qos,payload:'subscribed',direction:'INFO'})
    })
  }
}

function unsubscribeByIndex(idx){
  const s = state.subscriptions[idx]
  if(!s) return
  if(client && client.connected){ client.unsubscribe(s.topic, err=>{ if(!err) appendLog({topic:s.topic,qos:s.qos,payload:'unsubscribed',direction:'INFO'}) }) }
  state.subscriptions.splice(idx,1)
  saveState(); renderSubs()
}

function clearSubscriptions(){
  if(!confirm('Remover todas as inscriÃ§Ãµes?')) return
  if(client && client.connected){ state.subscriptions.forEach(s=> client.unsubscribe(s.topic)) }
  state.subscriptions = []
  saveState(); renderSubs()
}

function publish(){
  if(!client || !client.connected) return alert('Conecte-se primeiro')
  const topic = $('pubTopic').value.trim()
  if(!topic) return alert('TÃ³pico obrigatÃ³rio')
  const payload = $('pubPayload').value
  const qos = parseInt($('pubQos').value)
  const retain = $('pubRetain').checked
  client.publish(topic, payload, {qos, retain}, err=>{
    if(err) appendLog({topic,qos,payload:'publish error: '+String(err),direction:'ERROR'})
    else appendLog({topic,qos,payload:payload,direction:'SENT'})
    saveState(); renderLog()
  })
}

function appendLog(entry){
  const item = { ts: now(), topic: entry.topic, qos: entry.qos||0, payload: entry.payload||'', direction: entry.direction||'INFO' }
  state.log.push(item)
  // keep last 2000 entries max
  if(state.log.length>2000) state.log.shift()
  saveState(); renderLog()
}

// --- export/import config ---
function exportConfig(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'})
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a'); a.href = url; a.download = 'mqtt-client-config.json'; document.body.appendChild(a); a.click(); a.remove()
}

function importConfigFile(file){
  const reader = new FileReader()
  reader.onload = e=>{
    try{
      const parsed = JSON.parse(e.target.result)
      if(confirm('Importar config e substituir o estado atual?')){
        state = parsed
        saveState(); renderAll();
        alert('Config importada com sucesso')
      }
    }catch(err){ alert('Arquivo invÃ¡lido: '+err.message) }
  }
  reader.readAsText(file)
}

function downloadLog(){
  const blob = new Blob([state.log.map(l=>`[${l.ts}] ${l.direction} ${l.topic} (QoS ${l.qos})\n${l.payload}\n`).join('\n')], {type:'text/plain'})
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='mqtt-log.txt'; document.body.appendChild(a); a.click(); a.remove()
}

function clearLog(){ if(confirm('Limpar log?')){ state.log=[]; saveState(); renderLog() } }

function renderAll(){ renderConfig(); renderSubs(); renderLog() }

// --- wire events ---
document.addEventListener('DOMContentLoaded', ()=>{
  loadState()
  renderAll()
  // default broker if empty
  if(!state.config.broker) state.config.broker = 'wss://broker.hivemq.com:8884/mqtt'
  renderConfig()

  $('connectBtn').addEventListener('click', connect)
  $('disconnectBtn').addEventListener('click', disconnect)
  $('addTopicBtn').addEventListener('click', subscribeTopic)
  $('clearSubsBtn').addEventListener('click', clearSubscriptions)
  $('publishBtn').addEventListener('click', publish)
  $('exportBtn').addEventListener('click', exportConfig)
  $('importBtn').addEventListener('click', ()=>$('fileInput').click())
  $('fileInput').addEventListener('change', e=>{ if(e.target.files.length) importConfigFile(e.target.files[0]) })
  $('downloadLogBtn').addEventListener('click', downloadLog)
  $('clearLogBtn').addEventListener('click', clearLog)

  // filters
  $('filterTopic').addEventListener('input', renderLog)
  $('filterQos').addEventListener('change', renderLog)

  // keyboard shortcuts: Ctrl+Enter -> publish
  window.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key==='Enter') publish() })

})

</script>
</body>
</html>
